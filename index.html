<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather Calendar Feed - okairos.gr</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 600px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      margin: 0 auto;
      min-height: calc(100vh - 40px);
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .header h1 { font-size: 24px; margin-bottom: 8px; }
    .header p { font-size: 14px; opacity: 0.9; }

    .widget-container { padding: 20px; }

    .info-box {
      background: #f0f4ff;
      border: 1px solid #d0d8ff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 13px;
      color: #333;
      line-height: 1.6;
    }

    .info-box strong { color: #667eea; }

    .footer {
      padding: 15px 20px;
      background: #f8f9fa;
      border-top: 1px solid #e0e0e0;
      font-size: 12px;
      color: #666;
      text-align: center;
      display: flex;
      justify-content: center;
      margin-top: auto;
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: #333;
      margin: 20px 0 12px 0;
      padding-top: 15px;
      border-top: 2px solid #667eea;
    }

    .steps { list-style: none; counter-reset: step; }

    .steps li {
      counter-increment: step;
      margin-bottom: 15px;
      padding-left: 35px;
      position: relative;
      font-size: 13px;
      line-height: 1.6;
      color: #333;
    }

    .steps li:before {
      content: counter(step);
      position: absolute;
      left: 0;
      top: 0;
      background: #667eea;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
    }

    .code-block {
      background: #f5f5f5;
      border-left: 3px solid #667eea;
      padding: 10px 12px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
      word-break: break-all;
      margin: 8px 0;
      user-select: all;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    .calendar-item {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      padding: 10px;
      font-size: 12px;
    }

    .calendar-item strong {
      color: #667eea;
      display: block;
      margin-bottom: 4px;
    }

    code {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 12px;
      font-weight: 500;
    }

    a { color: #667eea; text-decoration: none; font-weight: 500; }
    a:hover { text-decoration: underline; }

    @media (max-width: 700px) {
      .container { border-radius: 0; box-shadow: none; }
      body { min-height: 100dvh; align-items: flex-start; }
      .calendar-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>Weather Calendar Feed</h1>
      <p>
        Live weather widget & calendar subscription powered by
        <a href="https://www.okairos.gr/" target="_blank" rel="noopener" style="color: white; font-weight: 500;">okairos.gr</a>
      </p>
    </div>

    <div class="widget-container">
      <!-- Current Weather Widget from okairos.gr -->
      <h2 class="section-title" style="margin-top: 0; padding-top: 0; border-top: none;">üå§Ô∏è Current Weather - Athens</h2>
      <div style="display: flex; justify-content: center; margin-bottom: 20px;">
        <div id="c_c5e081a87065ee7e6306a538dddd020b" class="completo">
          <h2 style="color: #000000; margin: 0 0 3px; padding: 2px; font: bold 13px/1.2 Verdana; text-align: center; width=100%">
            <a href="https://www.okairos.gr/%CE%B1%CE%B8%CE%AE%CE%BD%CE%B1.html" style="color: #000000; text-decoration: none; font: bold 13px/1.2 Verdana;">Œ∫Œ±ŒπœÅœåœÇ ŒëŒ∏ŒÆŒΩŒ±</a>
          </h2>
          <div id="w_c5e081a87065ee7e6306a538dddd020b" class="completo" style="height:100%"></div>
        </div>
        <script type="text/javascript" src="https://www.okairos.gr/widget/loader/c5e081a87065ee7e6306a538dddd020b"></script>
      </div>

      <!-- Subscribe to Calendar Feed -->
      <h2 class="section-title">üìÖ Add Weather to Your Calendar</h2>
      <div class="info-box">
        Subscribe to get daily weather forecasts for Athens automatically in Google Calendar, Apple Calendar, Outlook, or any calendar app!
      </div>

      <!-- Athens Calendar Feed -->
      <h3 style="font-size: 15px; font-weight: 600; margin-top: 15px; margin-bottom: 10px; color: #333;">üìç Athens Calendar Feed:</h3>
      <div class="calendar-item" style="max-width: 100%;">
        <strong>üèõÔ∏è Athens (ŒëŒ∏ŒÆŒΩŒ±)</strong>
        <div class="code-block" style="margin-top: 5px; font-size: 11px;">
          https://tzoral.github.io/okairos-ics-feed/feeds/athens.ics
        </div>
      </div>

      <div class="info-box" style="margin-top: 15px; background: #fff3cd; border-color: #ffc107;">
        <strong>üåç Want a different city or district?</strong><br />
        <a href="https://github.com/tzoral/okairos-ics-feed/issues/new" target="_blank" rel="noopener" style="color: #667eea;">Open a GitHub issue</a>
        to request a new location! I'll add it to the feed if it's available on okairos.gr.
      </div>

      <h2 class="section-title">üöÄ How to Subscribe</h2>
      <ol class="steps">
        <li>
          <strong>Copy the Athens Calendar Feed URL</strong> from above.
        </li>
        <li>
          <strong>Open Your Calendar App</strong> and follow the steps for your platform:
          <div class="calendar-grid">
            <div class="calendar-item">
              <strong>üîµ Google Calendar</strong>
              Settings ‚Üí Add other calendars ‚Üí From URL ‚Üí Paste
            </div>
            <div class="calendar-item">
              <strong>üçé Apple Calendar</strong>
              File ‚Üí New Calendar Subscription ‚Üí Paste URL
            </div>
            <div class="calendar-item">
              <strong>üìß Outlook</strong>
              Add calendar ‚Üí Subscribe from web ‚Üí Paste URL
            </div>
            <div class="calendar-item">
              <strong>üåê Other Apps</strong>
              Look for "Subscribe" or "Add from URL" option
            </div>
          </div>
        </li>
        <li>
          <strong>Done!</strong> Daily weather forecasts for Athens will appear automatically. Updates every morning at 06:00 Athens time.
        </li>
      </ol>

      <h2 class="section-title">‚ú® What You'll Get</h2>
      <div class="info-box">
        <strong>Daily Weather Calendar:</strong> Every morning at 06:00 Athens time, your calendar updates with:
        <ul style="margin-top: 8px; margin-left: 16px; font-size: 13px;">
          <li>üå°Ô∏è Minimum & Maximum Temperature</li>
          <li>üíß Precipitation Probability & Amount</li>
          <li>üí® Wind Speed</li>
          <li>üìÖ 7-day forecast automatically</li>
        </ul>
      </div>

      <!-- UPDATED PREVIEW: compact per-day description (matches new ICS output) -->
      <h2 class="section-title">üñºÔ∏è Calendar Event Preview</h2>
      <div class="info-box" style="font-family: monospace; white-space: pre; overflow-x: auto; font-size: 12px;">
        <div id="event-preview-title">Event title: (loading‚Ä¶)</div>
        <div id="event-preview-body" style="margin-top: 6px;">Fetching live preview from feeds/athens.ics‚Ä¶</div>
      </div>
    </div>

    <div class="footer">
      Built for calendar subscriptions ‚Ä¢ Powered by okairos.gr
    </div>
  </div>

  <script>
  // Fetch the latest Athens ICS and render first event (Google Calendar friendly: compact per-day description)
  (async function renderIcsPreview() {
    const titleEl = document.getElementById('event-preview-title');
    const bodyEl  = document.getElementById('event-preview-body');
    if (!titleEl || !bodyEl) return;

    const fallbackSummary = 'üå§Ô∏è 13¬∞C Partly Cloudy';
    const fallbackDescription =
`üå§Ô∏è Athens ‚Äî Œ£ŒÆŒºŒµœÅŒ± ‚Ä¢ Œ§œéœÅŒ± 13¬∞C
Min/Max: 9¬∞C / 14¬∞C
Œ£œÖŒΩŒ∏ŒÆŒ∫ŒµœÇ: Partly Cloudy
ŒëŒΩŒ±œÑŒøŒªŒÆ/ŒîœçœÉŒ∑: 07:36 / 17:37
Widget: https://tzoral.github.io/okairos-ics-feed/
Œ£ŒµŒªŒØŒ¥Œ±: https://www.okairos.gr/Œ±Œ∏ŒÆŒΩŒ±.html`;

    const fallback = () => {
      titleEl.textContent = `Event title: ${fallbackSummary}`;
      bodyEl.textContent = fallbackDescription;
    };

    // ICS helper: unfold folded lines (RFC 5545: lines starting with space/tab are continuations)
    const unfoldIcs = (txt) => txt.replace(/\r?\n[ \t]/g, '');

    // Extract full field value (handles folded lines + stops at next property)
    const getField = (eventBlock, fieldName) => {
      const re = new RegExp(
        `(?:^|\\n)${fieldName}(?:;[^:\\n]*)?:(.*?)(?=\\n[A-Z][A-Z0-9-]*?(?:;[^:\\n]*)?:|$)`,
        's'
      );
      const m = eventBlock.match(re);
      return m ? m[1].trim() : '';
    };

    // Unescape ICS text values
    const unescapeIcsText = (s) => s
      .replace(/\\n/g, '\n')
      .replace(/\\,/g, ',')
      .replace(/\\;/g, ';')
      .replace(/\\\\/g, '\\');

    try {
      const res = await fetch('feeds/athens.ics', { cache: 'no-cache' });
      if (!res.ok) throw new Error('HTTP ' + res.status);

      let txt = await res.text();
      txt = unfoldIcs(txt);

      // First VEVENT
      const evMatch = txt.match(/BEGIN:VEVENT([\s\S]*?)END:VEVENT/);
      if (!evMatch) return fallback();

      const ev = evMatch[1];

      const summaryRaw = getField(ev, 'SUMMARY');
      const descRaw    = getField(ev, 'DESCRIPTION');

      const summary = summaryRaw ? unescapeIcsText(summaryRaw) : '(no title)';
      const desc    = descRaw ? unescapeIcsText(descRaw) : '(no description)';

      titleEl.textContent = `Event title: ${summary}`;
      bodyEl.textContent  = desc;

    } catch (e) {
      console.warn('Preview fallback, could not fetch ICS:', e);
      fallback();
    }
  })();
  </script>
</body>
</html>
